name: Auto-Fill PR Description with CodeRabbit Summary

on:
  pull_request:
    types: [opened]

jobs:
  auto-fill-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for CodeRabbit Analysis
        run: |
          echo "Waiting 30 seconds for CodeRabbit to analyze the PR..."
          sleep 30

      - name: Get CodeRabbit Summary and Update PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            // Wait a bit more to ensure CodeRabbit has posted
            await new Promise(resolve => setTimeout(resolve, 10000));
            
            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number,
            });
            
            // Find CodeRabbit's comment (usually posted by coderabbitai bot)
            let coderabbitSummary = null;
            for (const comment of comments.data) {
              if (comment.user.login.includes('coderabbit') || 
                  comment.user.type === 'Bot' && comment.body.includes('Summary')) {
                coderabbitSummary = comment.body;
                break;
              }
            }
            
            // If CodeRabbit hasn't commented yet, try review comments
            if (!coderabbitSummary) {
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number,
              });
              
              for (const review of reviews.data) {
                if (review.user.login.includes('coderabbit') || review.user.type === 'Bot') {
                  coderabbitSummary = review.body;
                  break;
                }
              }
            }
            
            // Get current PR details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number,
            });
            
            let newDescription = pr.data.body || '';
            
            if (coderabbitSummary) {
              // Extract just the summary section if it exists
              let summarySection = coderabbitSummary;
              
              // Try to extract the main summary (before detailed comments)
              const summaryMatch = coderabbitSummary.match(/## Summary[\s\S]*?(?=##|$)/i);
              if (summaryMatch) {
                summarySection = summaryMatch[0];
              }
              
              // Prepare the auto-filled description
              newDescription = `<!-- Auto-generated by CodeRabbit -->
# ü§ñ AI-Generated Summary

${summarySection}

---

<!-- Please review the summary above and add any additional context below -->

## Description
${pr.data.title}

## Type of Change
- [ ] Bug fix (non-breaking change fixing an issue)
- [ ] New feature (non-breaking change adding functionality)
- [ ] Breaking change (fix or feature causing existing functionality to change)
- [ ] Documentation update
- [ ] Refactoring (no functional changes)
- [ ] Performance improvement
- [ ] Test addition/modification

## Related Issues
Closes #(issue number)

## Changes Made
<!-- CodeRabbit analysis is above. Add specific implementation details here -->
- 
- 
- 

## Testing
- [ ] Unit tests added/updated
- [ ] Integration tests added/updated
- [ ] Manual testing completed
- [ ] All tests passing

## Checklist
- [ ] Code follows project style guidelines
- [ ] Self-review completed
- [ ] Comments added for complex code
- [ ] Documentation updated
- [ ] No new warnings generated
- [ ] Tests added proving fix/feature works
- [ ] Dependent changes merged

## Screenshots (if applicable)

## Additional Notes
`;
              
              // Update the PR description
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number,
                body: newDescription,
              });
              
              console.log('‚úÖ PR description updated with CodeRabbit summary!');
              
              // Post a comment to notify the user
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: '‚úÖ **PR description has been auto-filled with CodeRabbit\'s AI summary!** ü§ñ\n\nPlease review the generated summary and add any additional context as needed.',
              });
            } else {
              console.log('‚ö†Ô∏è CodeRabbit summary not found yet. PR description will use template.');
              
              // Post a comment explaining the delay
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: '‚è≥ Waiting for CodeRabbit to analyze this PR. The description will be auto-filled once the analysis is complete.\n\nIn the meantime, please feel free to add your own description!',
              });
            }
